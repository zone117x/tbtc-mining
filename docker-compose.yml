version: "3.9"
services:
  foundation:
    build:
      dockerfile: ./dockerfiles/foundation.Dockerfile
    depends_on:
      postgres:
        condition: service_healthy
      bitcoin:
        condition: service_healthy
    restart: unless-stopped
    environment:
      FOUNDATION_SERVER_PORT: 3001
      STRATUM_PORT: 3002
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: foundation
      PGHOST: postgres
      PGPORT: 5432
      BITCOIN_RPC_HOST: bitcoin
      BITCOIN_RPC_PORT: 18332
      BITCOIN_RPC_USER: btc
      BITCOIN_RPC_PASSWORD: btc
      BITCOIN_ZMQ_HOST: bitcoin
      BITCOIN_ZMQ_PORT: 29000
      RECIPIENT_ADDR: tb1qc7sfev9vr5w5uqsft7rmy23s42yx50rac8ftrw
    volumes:
      - ./config/foundation:/app/configs
    ports:
      - '3001:3001' # foundation server
      - '3002:3002' # stratum

  postgres:
    image: "postgres:14"
    restart: unless-stopped
    expose:
      - '5432'
    volumes:
      - ./data/pg:/pg-data
    environment:
      PGUSER: postgres
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: foundation
      PGPORT: 5432
      PGDATA: /pg-data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready"]
      interval: 10s
      timeout: 5s
      retries: 5

  bitcoin:
    image: ruimarinho/bitcoin-core:22.0
    restart: unless-stopped
    volumes:
      - ./data/bitcoin:/home/bitcoin/.bitcoin
    command:
      -printtoconsole
      -testnet=1
      -server=1
      -rpcuser=btc
      -rpcpassword=btc
      -rpcbind=0.0.0.0
      -rpcallowip=0.0.0.0/0
      -rpcport=18332
      -deprecatedrpc=accounts
      -zmqpubrawblock=tcp://0.0.0.0:29000
      -zmqpubrawtx=tcp://0.0.0.0:29000
      -zmqpubhashtx=tcp://0.0.0.0:29000
      -zmqpubhashblock=tcp://0.0.0.0:29000
    healthcheck:
      test: curl -f --data-binary '{"jsonrpc":"1.0","id":"curltext","method":"getblockchaininfo","params":[]}' -H 'content-type:text/plain;' http://btc:btc@127.0.0.1:18332 || exit 1
      interval: 5s
      timeout: 30s
      retries: 99999999
    expose:
      - '18332' #rpc
      - '18333' #p2p
    # ports:
    #  - '18332:18332'
    #  - '18333:18333'

  bootstrap:
    profiles: ["bootstrap"]
    build:
      dockerfile: ./dockerfiles/bootstrap.Dockerfile
    volumes:
      - ./data/bitcoin/testnet3:/data
